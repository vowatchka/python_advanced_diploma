variables:
  PYTHON_IMAGE: python:3.9-slim
  POSTGRES_IMAGE: postgres:15.2-alpine
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  WORK_DIR: ./tweetty
  POSTGRES_DB: test_db
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test
  POSTGRES_URL: "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"

image: $PYTHON_IMAGE

cache:
  key:
    files:
      - ./requirements.txt
  paths:
    - .cache/pip

before_script:
  - python --version  # for debug
  - python -m pip install --upgrade pip setuptools wheel
  - python -m pip install -r requirements.txt

stages:
  - lint
  - test
  - release

linting:
  stage: lint
  script:
    - chmod +x ./lint.sh
    - ./lint.sh $WORK_DIR
  only:
    - main
    - master
    - merge_requests

testing:
  stage: test
  services:
    - $POSTGRES_IMAGE
  script:
    - pytest -v --color=yes $WORK_DIR
  only:
    - main
    - master
    - merge_requests

release:
  stage: release
  before_script:
    # degug
    - echo $GITLAB_CI
    # install git
    - apt-get update -y
    - apt-get install -y git
    # setup git
    - git config --local user.name "semantic-release"
    - git config --local user.email "semantic-release"
    - git switch $CI_COMMIT_BRANCH
    # remove unused tags
    - git tag -d $(git tag -l)
    - git pull
    # install python-semantic-release
    - python -m pip install --upgrade pip setuptools wheel
    - python -m pip install python-semantic-release~=7.34
  script:
    - semantic-release publish -v INFO
  only:
    - main
    - master
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\d+\.\d+\.\d+/
